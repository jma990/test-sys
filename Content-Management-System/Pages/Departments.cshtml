@page
@model Content_Management_System.Pages.DepartmentsModel
@{
}

@await Html.PartialAsync(@Url.Content(PathDirectory._ViewUsers), Model)
@await Html.PartialAsync(@Url.Content(PathDirectory._AddDepartment), Model)

<link rel="stylesheet" href="~/css/departments.css" />

<div class="departments-page">
    <div class="departments-header">
        <div class="header-content">
            <h1><i class="fas fa-building"></i> Departments</h1>
            <p>Manage your organization's departments and team members</p>
        </div>
        <button type="button" class="btn-add-department" data-bs-toggle="modal" data-bs-target="#addDepartmentModal">
            <i class="fas fa-plus"></i> Add Department
        </button>
    </div>

    @Html.AntiForgeryToken()
    
    <div class="filter-section">
        <div class="filter-buttons">
            <a asp-page="@Url.Content(PathDirectory.DepartmentsPage)" asp-route-filter="all"
               class="filter-btn @(Model.Filter == "all" ? "active" : "")">
                <i class="fas fa-list"></i> All
            </a>
            <a asp-page="@Url.Content(PathDirectory.DepartmentsPage)" asp-route-filter="active"
               class="filter-btn @(Model.Filter == "active" ? "active" : "")">
                <i class="fas fa-check-circle"></i> Active
            </a>
            <a asp-page="@Url.Content(PathDirectory.DepartmentsPage)" asp-route-filter="inactive"
               class="filter-btn @(Model.Filter == "inactive" ? "active" : "")">
                <i class="fas fa-ban"></i> Inactive
            </a>
        </div>
    </div>

    <div class="departments-table-wrapper">
        <table class="departments-table">
            <thead>
                <tr>
                    <th>Department Name</th>
                    <th class="text-center">Number of Users</th>
                    <th class="text-center">Status</th>
                    <th class="text-center">Action</th>
                </tr>
            </thead>
            <tbody>
            @foreach (var dept in Model.Departments)
            {
                <tr data-id="@dept.ID">
                    <td class="dept-name-cell view-mode">@dept.DepartmentName</td>
                    <td class="text-center user-count">@dept.UserCount</td>
                    <td class="text-center view-mode status-cell">
                        @if (dept.IsActive)
                        {
                            <span class="status-badge status-active">Active</span>
                        }
                        else
                        {
                            <span class="status-badge status-inactive">Inactive</span>
                        }
                    </td>
                    <td class="text-center action-cell">
                        <div class="action-buttons">
                            <button type="button" class="action-btn edit-btn" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button type="button" class="action-btn save-btn d-none" title="Save">
                                <i class="fas fa-check"></i>
                            </button>
                            @if (dept.UserCount == 0)   
                            {
                                <button type="button" class="action-btn archive-btn" 
                                        data-id="@dept.ID" data-active="@dept.IsActive"
                                        title="@(dept.IsActive ? "Archive" : "Unarchive")">
                                    @if (dept.IsActive)
                                    {
                                        <i class="fas fa-trash-alt"></i>
                                    }
                                    else
                                    {
                                        <i class="fas fa-undo"></i>
                                    }
                                </button>
                            }
                            <button type="button"
                                    class="action-btn view-users-btn"
                                    data-bs-toggle="modal"
                                    data-bs-target="#viewUsersModal"
                                    data-id="@dept.ID"
                                    data-name="@dept.DepartmentName"
                                    title="View Users">
                                <i class="fas fa-users"></i>
                            </button>
                        </div>

                        <form class="edit-form d-none" method="post" asp-page-handler="Edit">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="EditID" value="@dept.ID" />
                            <input type="text" name="EditDepartmentName" class="form-control form-control-sm" />
                            <input type="hidden" name="Filter" value="@Model.Filter" /> 
                        </form>

                        <form class="archive-form d-none" method="post" asp-page-handler="Archive">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="ArchiveID" value="@dept.ID" />
                            <input type="hidden" name="Filter" value="@Model.Filter" /> 
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            enableTableSorting("table", [3]);
            // -----------------------------
            const rows = document.querySelectorAll("table tbody tr");
            rows.forEach((row) => {
                const editBtn = row.querySelector(".edit-btn");
                const saveBtn = row.querySelector(".save-btn");
                const form = row.querySelector(".edit-form");
                const realInput = form.querySelector("input[name='EditDepartmentName']");
                const viewCell = row.querySelector(".view-mode");

                editBtn.addEventListener("click", () => {
                    // fill input with current text
                    realInput.value = viewCell.textContent.trim();

                    // replace view with clone input
                    const clone = realInput.cloneNode(true);
                    clone.removeAttribute("name");
                    clone.value = realInput.value;
                    clone.classList.add("form-control", "form-control-sm");

                    clone.addEventListener("input", () => {
                        realInput.value = clone.value;
                    });

                    viewCell.innerHTML = "";
                    viewCell.appendChild(clone);

                    editBtn.classList.add("d-none");
                    saveBtn.classList.remove("d-none");
                    form.classList.remove("d-none");
                    form.style.display = "none";
                });

                saveBtn.addEventListener("click", (e) => {
                    e.preventDefault();
                    const cloneInput = viewCell.querySelector("input");
                    realInput.value = cloneInput.value.trim();
                    form.submit();
                });

                // Archive/Unarchive button confirmation
                const archiveBtn = row.querySelector(".archive-btn");
                if (archiveBtn) {   // check if button exists first
                    archiveBtn.addEventListener("click", () => {
                        const isActive = archiveBtn.getAttribute("data-active") === "True";  
                        const actionText = isActive ? "archived" : "unarchived";
                        const actionTitle = isActive ? "Archive Department?" : "Unarchive Department?";

                        Swal.fire({
                            title: actionTitle,
                            text: `This department will be ${actionText}.`,
                            icon: "warning",
                            showCancelButton: true,
                            confirmButtonColor: "#3085d6",
                            cancelButtonColor: "#d33",
                            confirmButtonText: "Confirm"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                const archiveForm = row.querySelector(".archive-form");
                                archiveForm.submit();
                            }
                        });
                    });
                }
            });

            // SweetAlert popup if invalid user input
            @if (!string.IsNullOrEmpty(Model.AlertMessage))
            {
                <text>
                Swal.fire({
                    icon: '@Model.AlertType',
                    title: '@Model.AlertMessage',
                    confirmButtonText: 'OK'
                });
                </text>

                // Clear TempData so it doesn't show again
                @TempData.Remove("AlertMessage");
                @TempData.Remove("AlertType");
            }
        });
    </script>
}
