@page
@model Content_Management_System.Pages.AccountCreationModel
@{
    ViewData["NoContainer"] = true;
    Layout = "_Layout";
}

@section Styles {
    <link rel="stylesheet" href="@Url.Content(PathDirectory.AccountCreationCSS)" />
}

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            document.querySelector(".account-creation-form").addEventListener("submit", function (event) {
                showLoading('.create-account-btn', '.btn-text', '.btn-loader');
            });

            @if (TempData["Message"] != null)
            {
                var message = TempData["Message"].ToString();
                var tempPassword = "";

                if (message.Contains("Temporary password is:"))
                {
                    var parts = message.Split("Temporary password is:");
                    var infoMessage = parts[0].Trim();
                    tempPassword = parts.Length > 1 ? parts[1].Trim() : "";
                }

                <text>
                    const msg = "@message";
                    const tempPass = "@tempPassword";

                    if (tempPass && tempPass.length > 0) {
                        Swal.fire({
                            icon: 'info',
                            title: 'Temporary Password',
                            html: `
                                <p>User created successfully.</p>
                                <p><strong>${tempPass}</strong></p>
                                <p id="timer-text">This password will disappear in <b>30</b> seconds.</p>
                            `,
                            timer: 30000,
                            timerProgressBar: true,
                            allowOutsideClick: true,
                            allowEscapeKey: true,
                            allowEnterKey: true,
                            didOpen: () => {
                                const timerText = Swal.getPopup().querySelector('#timer-text').querySelector('b');
                                const interval = setInterval(() => {
                                    const timeLeft = Math.ceil(Swal.getTimerLeft() / 1000);
                                    timerText.textContent = timeLeft;
                                }, 1000);

                                Swal.showLoading();

                                Swal.getPopup().addEventListener('swal:close', () => {
                                    clearInterval(interval);
                                });
                            },
                            willClose: () => {
                                location.reload();
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: 'info',
                            title: 'Notification',
                            text: msg,
                            willClose: () => {
                                location.reload();
                            }
                        });
                    }
                </text>
            }
        });
    </script>
}

<div class="account-creation-container">
    <div class="account-creation-card">
        <div class="account-creation-header">
            <h2>Create Account</h2>
            <p>Fill in the details to create a new user account</p>
        </div>

        <form method="post" class="account-creation-form" id="accountCreationForm" novalidate>
            <div class="form-group">
                <div class="input-wrapper">
                    <input asp-for="FirstName" placeholder=" " required />
                    <label for="FirstName">First Name<span class="text-danger">*</span></label>
                </div>
                @Html.ValidationMessageFor(m => m.FirstName, "", new { @class = "error-message show" })
            </div>

            <div class="form-group">
                <div class="input-wrapper">
                    <input asp-for="MiddleName" placeholder=" " />
                    <label for="MiddleName">Middle Name</label>
                </div>
            </div>

            <div class="form-group">
                <div class="input-wrapper">
                    <input asp-for="LastName" placeholder=" " required />
                    <label for="LastName">Last Name<span class="text-danger">*</span></label>
                </div>
                @Html.ValidationMessageFor(m => m.LastName, "", new { @class = "error-message show" })
            </div>

            <div class="form-group">
                <div class="input-wrapper">
                    <input asp-for="Email" type="email" placeholder=" " required />
                    <label for="Email">Email Address<span class="text-danger">*</span></label>
                </div>
                @Html.ValidationMessageFor(m => m.Email, "", new { @class = "error-message show" })
            </div>

            <div class="form-group">
                <div class="input-wrapper">
                    <select asp-for="DepartmentID" required>
                        <option value="">-- Select Department --</option>
                        @foreach (var dept in Model.Departments)
                        {
                            <option value="@dept.ID">@dept.DepartmentName</option>
                        }
                    </select>
                    <label for="DepartmentID">Department<span class="text-danger">*</span></label>
                </div>
            </div>

            <div class="form-group">
                <div class="input-wrapper">
                    <select asp-for="Role" required>
                        @if (User.IsInRole("SuperAdmin"))
                        {
                            <option value="1">Admin</option>
                            <option value="2">Member</option>
                        }
                        else if (User.IsInRole("Admin"))
                        {
                            <option value="2">Member</option>
                        }
                    </select>
                    <label for="Role">Role<span class="text-danger">*</span></label>
                </div>
            </div>

            <button type="submit" class="create-account-btn">
                <span class="btn-text">Create Account</span>
                <span class="btn-loader"></span>
            </button>
        </form>
    </div>
</div>
