@page
@model Content_Management_System.Pages.UserManagementModel
@{
}

@section Styles {
    <link rel="stylesheet" href="~/css/user-management.css" asp-append-version="true" />
}

@await Html.PartialAsync(@Url.Content(PathDirectory._ResetPasswordLogs), Model)
@Html.AntiForgeryToken()

<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="bi bi-people-fill me-2"></i>User Management
                    </h4>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-light btn-sm" onclick="refreshUsers()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="card-body">
                    @if (Model.Users == null || !Model.Users.Any())
                    {
                        <div class="text-center py-5">
                            <i class="bi bi-people display-4 text-muted mb-3"></i>
                            <h5 class="text-muted">No users available</h5>
                            <p class="text-muted">There are currently no users to manage.</p>
                        </div>
                    }
                    else
                    {
                        <!-- Search and Filter Section -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" id="searchInput" class="form-control" placeholder="Search users...">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-funnel"></i></span>
                                    <select id="roleFilter" class="form-select">
                                        <option value="">All Roles</option>
                                        <option value="Admin">Admin</option>
                                        <option value="User">User</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Users Table -->
                        <div class="table-responsive">
                            <table id="usersTable" class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">
                                            <i class="bi bi-person me-1"></i>Name
                                            <button class="btn btn-link btn-sm p-0 ms-1 sort-btn" data-column="0">
                                                <i class="bi bi-chevron-expand"></i>
                                            </button>
                                        </th>
                                        <th scope="col">
                                            <i class="bi bi-envelope me-1"></i>Email
                                            <button class="btn btn-link btn-sm p-0 ms-1 sort-btn" data-column="1">
                                                <i class="bi bi-chevron-expand"></i>
                                            </button>
                                        </th>
                                        <th scope="col">
                                            <i class="bi bi-shield me-1"></i>Role
                                            <button class="btn btn-link btn-sm p-0 ms-1 sort-btn" data-column="2">
                                                <i class="bi bi-chevron-expand"></i>
                                            </button>
                                        </th>
                                        <th scope="col">
                                            <i class="bi bi-building me-1"></i>Department
                                            <button class="btn btn-link btn-sm p-0 ms-1 sort-btn" data-column="3">
                                                <i class="bi bi-chevron-expand"></i>
                                            </button>
                                        </th>
                                        <th scope="col">
                                            <i class="bi bi-calendar me-1"></i>Created At
                                            <button class="btn btn-link btn-sm p-0 ms-1 sort-btn" data-column="4">
                                                <i class="bi bi-chevron-expand"></i>
                                            </button>
                                        </th>
                                        <th scope="col" class="text-center">
                                            <i class="bi bi-gear me-1"></i>Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var user in Model.Users)
                                    {
                                        <tr class="user-row" data-role="@user.Role" data-archived="@user.IsArchived.ToString().ToLower()">
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <div class="avatar-circle me-2 bg-primary text-white">
                                                        @($"{user.FirstName[0]}{user.LastName[0]}".ToUpper())
                                                    </div>
                                                    <div>
                                                        <div class="fw-semibold">@($"{user.FirstName} {user.LastName}")</div>
                                                        @if (user.IsArchived)
                                                        {
                                                            <small class="text-muted"><i class="bi bi-archive me-1"></i>Archived</small>
                                                        }
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <a href="mailto:@user.Email" class="text-decoration-none">@user.Email</a>
                                            </td>
                                            <td>
                                                <span class="badge bg-@(user.Role == UserRole.Admin ? "warning" : "secondary")">
                                                    @user.Role
                                                </span>
                                            </td>
                                            <td>@(user.Department?.DepartmentName ?? "No Department")</td>
                                            <td>
                                                <small class="text-muted">@user.CreatedAt.ToString("MMM dd, yyyy")</small>
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group">
                                                    <button type="button"
                                                            class="btn btn-sm btn-outline-danger"
                                                            title="Reset Password"
                                                            onclick="resetPassword(@user.ID, '@user.FirstName @user.LastName')">
                                                        <i class="bi bi-arrow-repeat"></i>
                                                    </button>
                                                    <button type="button"
                                                            class="btn btn-sm btn-outline-info"
                                                            title="View Reset Password Logs"
                                                            onclick="showResetLogs(@user.ID, '@user.FirstName @user.LastName')">
                                                        <i class="bi bi-journal-text"></i>
                                                    </button>
                                                    <button type="button"
                                                            class="btn btn-sm btn-outline-@(user.IsArchived ? "success" : "secondary")"
                                                            title="@(user.IsArchived ? "Unarchive User" : "Archive User")"
                                                            onclick="toggleArchive(@user.ID, '@user.FirstName @user.LastName', @user.IsArchived.ToString().ToLower())">
                                                        <i class="bi @(user.IsArchived ? "bi-box-arrow-in-up" : "bi-archive")"></i>
                                                    </button>
                                                    @if (User.FindFirstValue(ClaimTypes.Role) == nameof(UserRole.SuperAdmin))
                                                    {
                                                        <button type="button"
                                                                class="btn btn-sm btn-outline-primary"
                                                                title="Change Department"
                                                                onclick="changeDepartment(@user.ID, '@user.FirstName @user.LastName')">
                                                            <i class="bi bi-building"></i>
                                                        </button>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav aria-label="User pagination" class="mt-4">
                            <ul class="pagination justify-content-center" id="pagination">
                                <!-- Pagination will be generated by JavaScript -->
                            </ul>
                        </nav>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        const itemsPerPage = 10;
        let filteredUsers = [];

        document.addEventListener("DOMContentLoaded", () => {
            initializeUserManagement();
        });

        function initializeUserManagement() {
            const searchInput = document.getElementById('searchInput');
            const roleFilter = document.getElementById('roleFilter');

            searchInput.addEventListener('input', filterAndDisplayUsers);
            roleFilter.addEventListener('change', filterAndDisplayUsers);

            // Initialize sorting
            document.querySelectorAll('.sort-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const column = parseInt(e.currentTarget.dataset.column);
                    sortTable(column);
                });
            });

            filterAndDisplayUsers();
        }

        function filterAndDisplayUsers() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const rows = document.querySelectorAll('.user-row');

            filteredUsers = Array.from(rows).filter(row => {
                const name = row.cells[0].textContent.toLowerCase();
                const email = row.cells[1].textContent.toLowerCase();
                const role = row.dataset.role;
                const archived = row.dataset.archived === 'true';

                const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);
                const matchesRole = !roleFilter || role === roleFilter;
                const notArchived = !archived; // Hide archived users by default

                return matchesSearch && matchesRole && notArchived;
            });

            displayPage(1);
        }

        function displayPage(page) {
            currentPage = page;
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;

            // Hide all rows first
            document.querySelectorAll('.user-row').forEach(row => {
                row.style.display = 'none';
            });

            // Show filtered rows for current page
            filteredUsers.slice(startIndex, endIndex).forEach(row => {
                row.style.display = '';
            });

            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Previous button
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="displayPage(${currentPage - 1})">Previous</a>`;
            pagination.appendChild(prevLi);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="#" onclick="displayPage(${i})">${i}</a>`;
                pagination.appendChild(li);
            }

            // Next button
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="displayPage(${currentPage + 1})">Next</a>`;
            pagination.appendChild(nextLi);
        }

        function sortTable(column) {
            const tbody = document.querySelector('#usersTable tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const isAscending = tbody.dataset.sortOrder !== 'asc';

            rows.sort((a, b) => {
                const aVal = a.cells[column].textContent.trim().toLowerCase();
                const bVal = b.cells[column].textContent.trim().toLowerCase();

                if (column === 4) { // Date column
                    return isAscending ?
                        new Date(aVal) - new Date(bVal) :
                        new Date(bVal) - new Date(aVal);
                }

                return isAscending ?
                    aVal.localeCompare(bVal) :
                    bVal.localeCompare(aVal);
            });

            tbody.dataset.sortOrder = isAscending ? 'asc' : 'desc';
            rows.forEach(row => tbody.appendChild(row));

            // Update sort icons
            document.querySelectorAll('.sort-btn i').forEach(icon => {
                icon.className = 'bi bi-chevron-expand';
            });
            const currentBtn = document.querySelector(`.sort-btn[data-column="${column}"] i`);
            currentBtn.className = `bi bi-chevron-${isAscending ? 'up' : 'down'}`;

            filterAndDisplayUsers();
        }

        function refreshUsers() {
            location.reload();
        }

        async function showResetLogs(userId, userName) {
            const tableBody = document.getElementById("resetLogsTableBody");
            tableBody.innerHTML = `<tr><td colspan="2" class="text-center">Loading...</td></tr>`;

            try {
                const res = await fetch(`/UserManagement?handler=GetResetLogs&userId=${userId}`);
                if (!res.ok) throw new Error("Failed to load logs");

                const logs = await res.json();

                if (logs.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="2" class="text-center text-muted">No logs found</td></tr>`;
                } else {
                    tableBody.innerHTML = logs.map(log => `
                        <tr>
                            <td>${log.adminName}</td>
                            <td>${new Date(log.resetAt).toLocaleString()}</td>
                        </tr>
                    `).join("");
                }

                document.getElementById("resetLogsModalLabel").innerText = `Reset Password Logs - ${userName}`;
                new bootstrap.Modal(document.getElementById("resetLogsModal")).show();

            } catch (err) {
                console.error(err);
                tableBody.innerHTML = `<tr><td colspan="2" class="text-danger text-center">Error loading logs</td></tr>`;
            }
        }


        function resetPassword(userId, userName) {
            let attempts = 0;
            const maxAttempts = 4;

            Swal.fire({
                title: 'Reset Password',
                text: `Do you want to reset the password of ${userName}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Confirm',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (!result.isConfirmed) return;

                Swal.fire({
                    title: 'Enter your Password',
                    input: 'password',
                    inputPlaceholder: 'Enter your password',
                    inputAttributes: {
                        autocapitalize: 'off',
                        autocorrect: 'off'
                    },
                    showCancelButton: true,
                    confirmButtonText: 'Submit',
                    cancelButtonText: 'Cancel',
                    allowOutsideClick: () => !Swal.isLoading(),
                    preConfirm: async (password) => {
                        if (!password) {
                            Swal.showValidationMessage("Password is required!");
                            return false;
                        }

                        try {
                            const res = await fetch('/UserManagement/VerifyPassword', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                credentials: 'same-origin',
                                body: JSON.stringify({ userID: userId, password: password })
                            });

                            const data = await res.json().catch(() => ({}));

                            if (!res.ok) {
                                attempts++;
                                if (attempts >= maxAttempts) {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Too Many Attempts',
                                        text: 'You have been locked out. Refreshing page...',
                                        allowOutsideClick: false,
                                        allowEscapeKey: false,
                                        allowEnterKey: false,
                                        showConfirmButton: false,
                                        timer: 5000, 
                                        didOpen: () => {
                                            Swal.showLoading();
                                        },
                                        willClose: () => {
                                            location.reload();
                                        }
                                    });
                                }
                                else {
                                    Swal.showValidationMessage(
                                        `${data?.message || 'Invalid password'} (${attempts}/${maxAttempts} attempts used)`
                                    );
                                }
                                return false;
                            }
                            return data;
                        } catch (err) {
                            Swal.showValidationMessage(err?.message || 'Network error. Please try again.');
                            return false;
                        }
                    }
                }).then((innerResult) => {
                     if (innerResult.isConfirmed) {
                        const data = innerResult.value || {};
                        Swal.fire({
                            icon: 'info',
                            title: 'Temporary Password',
                            html: `
                                <p><strong>${data.newPassword}</strong></p>
                                <p id="timer-text">This password will disappear in <b>30</b> seconds.</p>
                            `,
                            timer: 30000,
                            timerProgressBar: true,
                            allowOutsideClick: true,
                            allowEscapeKey: true,
                            allowEnterKey: true,
                            didOpen: () => {
                                const timerText = Swal.getPopup().querySelector('#timer-text').querySelector('b');
                                const interval = setInterval(() => {
                                    const timeLeft = Math.ceil(Swal.getTimerLeft() / 1000);
                                    timerText.textContent = timeLeft;
                                }, 1000);

                                Swal.showLoading();

                                Swal.getPopup().addEventListener('swal:close', () => {
                                    clearInterval(interval);
                                });
                            }
                        });
                    }
                });
            });
        }

        async function toggleArchive(userID, userName, isArchived) {
            const action = isArchived ? 'unarchive' : 'archive';
            const result = await Swal.fire({
                title: `${action.charAt(0).toUpperCase() + action.slice(1)} User`,
                text: `Are you sure you want to ${action} ${userName}?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: `Confirm`,
                cancelButtonText: 'Cancel'
            });

            if (!result.isConfirmed) return;

            try {
                const csrfToken = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const res = await fetch(`/UserManagement?handler=ToggleArchive`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({ userID: userID })
                });

                if (!res.ok) throw new Error("Failed to send userID");

                const data = await res.json();
                await Swal.fire({
                    title: 'Success',
                    text: data.message,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
                location.reload(); 
            } 
            catch (err) {
                console.error("Error sending userID:", err);
                await Swal.fire({
                    title: 'Error',
                    text: 'An error occurred while processing the request.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

        async function changeDepartment(userId, userName) {
            try {
                // Fetch the list of active departments
                const res = await fetch(`/UserManagement/GetDepartments`);
                if (!res.ok) throw new Error("Failed to load departments");

                const departments = await res.json();

                // Show SweetAlert with a dropdown for department selection
                const { value: departmentId } = await Swal.fire({
                    title: `Change Department for ${userName}`,
                    input: 'select',
                    inputOptions: departments.reduce((options, dept) => {
                        options[dept.id] = dept.name;
                        return options;
                    }, {}),
                    inputPlaceholder: 'Select a department',
                    showCancelButton: true,
                    confirmButtonText: 'Change',
                    cancelButtonText: 'Cancel'
                });

                if (!departmentId) return;

                // Send the selected department to the backend
                const csrfToken = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const updateRes = await fetch(`/UserManagement?handler=ChangeDepartment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': csrfToken
                    },
                    body: JSON.stringify({ userId, departmentId })
                });

                if (!updateRes.ok) throw new Error("Failed to change department");

                const data = await updateRes.json();

                // Show success message
                await Swal.fire({
                    title: 'Success',
                    text: data.message,
                    icon: 'success',
                    confirmButtonText: 'OK'
                });

                location.reload(); // Reload the page to reflect changes
            } catch (err) {
                console.error("Error changing department:", err);
                await Swal.fire({
                    title: 'Error',
                    text: 'An error occurred while changing the department.',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }

    </script>
}
